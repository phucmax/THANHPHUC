-- farmfruit 2.txt
-- Gộp UI + Fly pickup (speed 350) + ESP + webhook notify (require module NightXWebhook in ReplicatedStorage)

-- Cấu hình
getgenv().team = "Pirates" -- Marines
getgenv().AutoCollect = true -- bật/tắt auto collect
getgenv().FlySpeed = 350 -- tốc độ bay (studs/giây)
getgenv().PickupDistance = 6 -- khoảng cách để dừng và thử nhặt (studs)
getgenv().ESPEnabled = true -- bật/tắt ESP

-- Wait until player/data loaded
repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer:FindFirstChild("DataLoaded")

-- Tự động chọn team với phương pháp đáng tin cậy hơn
if game:GetService("Players").LocalPlayer.PlayerGui:FindFirstChild("Main (minimal)") then
    repeat
        task.wait()
        local l_Remotes_0 = game.ReplicatedStorage:WaitForChild("Remotes")
        l_Remotes_0.CommF_:InvokeServer("SetTeam", getgenv().team)
        task.wait(3)
    until not game:GetService("Players").LocalPlayer.PlayerGui:FindFirstChild("Main (minimal)")
end

-- Tiếp tục đợi GUI chính tải
repeat task.wait() until game.Players.LocalPlayer.PlayerGui:FindFirstChild("Main")

-- >>> TẢI UI <
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Tạo ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ImageWithBlur"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Tạo hiệu ứng blur full màn hình
local blurEffect = Instance.new("BlurEffect")
blurEffect.Size = 24
blurEffect.Parent = game:GetService("Lighting")

-- Frame chứa toàn bộ UI
local containerFrame = Instance.new("Frame")
containerFrame.Size = UDim2.new(1, 0, 1, 0)
containerFrame.Position = UDim2.new(0, 0, 1, 0) -- bắt đầu từ dưới màn hình
containerFrame.BackgroundTransparency = 1
containerFrame.Parent = screenGui

-- Transparent background frame
local transparentFrame = Instance.new("Frame")
transparentFrame.Size = UDim2.new(1, 0, 1, 0)
transparentFrame.BackgroundTransparency = 1
transparentFrame.Parent = containerFrame

-- Hình ảnh ở giữa màn hình
local imageLabel = Instance.new("ImageLabel")
imageLabel.Size = UDim2.new(0, 170, 0, 170)
imageLabel.Position = UDim2.new(0.5, -100, 0.5, -120)
imageLabel.BackgroundTransparency = 1
imageLabel.Image = "rbxassetid://91881585928344"
imageLabel.Parent = containerFrame

-- Label hiển thị thời gian
local timeLabel = Instance.new("TextLabel")
timeLabel.Size = UDim2.new(0, 200, 0, 20)
timeLabel.Position = UDim2.new(0.5, -100, 0.5, 155)
timeLabel.BackgroundTransparency = 1
timeLabel.TextColor3 = Color3.new(230/255, 230/255, 255/255)
timeLabel.TextScaled = true
timeLabel.Font = Enum.Font.GothamBold
timeLabel.Text = "00 Hour (h) 00 Minute (m) 00 Second (s)"
timeLabel.Parent = containerFrame

-- Lixuryx Hub Auto Bounty label (above image)
local lixuryxLabel = Instance.new("TextLabel")
lixuryxLabel.Size = UDim2.new(0, 300, 0, 40)
lixuryxLabel.Position = UDim2.new(0.5, -150, 0.5, -200)
lixuryxLabel.BackgroundTransparency = 1
lixuryxLabel.TextColor3 = Color3.new(230/255, 230/255, 255/255)
lixuryxLabel.TextScaled = true
lixuryxLabel.Font = Enum.Font.GothamBold
lixuryxLabel.Text = "NightX | Find Fruits"
lixuryxLabel.Parent = containerFrame

-- Label nhỏ nằm trên: (free)
local premiumLabel = Instance.new("TextLabel")
premiumLabel.Size = UDim2.new(0, 90, 0, 15)
premiumLabel.Position = UDim2.new(0.5, 125, 0.5, -200) -- lệch lên và sang phải
premiumLabel.BackgroundTransparency = 1
premiumLabel.TextColor3 = Color3.fromRGB(230, 230, 255)
premiumLabel.TextScaled = true
premiumLabel.Font = Enum.Font.GothamBold
premiumLabel.Text = "[Free]"
premiumLabel.Parent = containerFrame

-- Discord link label (below Lixuryx)
local discordLabel = Instance.new("TextLabel")
discordLabel.Size = UDim2.new(0, 120, 0, 10)
discordLabel.Position = UDim2.new(0.5, -63, 0.5, 150)
discordLabel.BackgroundTransparency = 1
discordLabel.TextColor3 = Color3.new(230/255, 230/255, 255/255)
discordLabel.TextScaled = true
discordLabel.Font = Enum.Font.GothamBold
discordLabel.Text = "https://discord.gg/3EwNuXTNCU"
discordLabel.Parent = containerFrame

-- Hiển thị tên người chơi ở góc trên bên phải
local playerNameLabel = Instance.new("TextLabel")
playerNameLabel.Size = UDim2.new(0, 80, 0, 8)
playerNameLabel.Position = UDim2.new(1, -85, 0, -50)
playerNameLabel.BackgroundTransparency = 1
playerNameLabel.TextColor3 = Color3.new(230/255, 230/255, 255/255)
playerNameLabel.TextScaled = true
playerNameLabel.Font = Enum.Font.GothamBold
playerNameLabel.TextXAlignment = Enum.TextXAlignment.Right
playerNameLabel.Text = "(" .. player.Name ..")"
playerNameLabel.Parent = containerFrame

-- Tween container từ dưới lên
local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local goal = { Position = UDim2.new(0, 0, 0, 0) }
local tween = TweenService:Create(containerFrame, tweenInfo, goal)
tween:Play()

-- Bắt đầu đếm thời gian sau tween
local startTime = tick()
tween.Completed:Connect(function()
    task.spawn(function()
        while screenGui.Parent do
            local elapsed = math.floor(tick() - startTime)
            local hours = math.floor(elapsed / 3600)
            local minutes = math.floor((elapsed % 3600) / 60)
            local seconds = elapsed % 60
            timeLabel.Text = string.format("%02d Hour (h) %02d Minute (m) %02d Second (s)", hours, minutes, seconds)
            task.wait(1)
        end
    end)
end)

-- Attempt to require webhook module from ReplicatedStorage
local WebhookModule = nil
local success, err = pcall(function()
    if game:GetService("ReplicatedStorage"):FindFirstChild("NightXWebhook") then
        WebhookModule = require(game:GetService("ReplicatedStorage"):WaitForChild("NightXWebhook"))
    end
end)
if not success then
    WebhookModule = nil
end

-- Utility: find tool that is a fruit in character/backpack
local function findFruitTool()
    -- check character first
    local char = player.Character
    if char then
        local t = char:FindFirstChildOfClass("Tool")
        if t and string.find(t.Name or "", "Fruit") then return t end
    end
    -- check backpack
    local bp = player:FindFirstChild("Backpack")
    if bp then
        for _, it in ipairs(bp:GetChildren()) do
            if it:IsA("Tool") and string.find(it.Name or "", "Fruit") then
                return it
            end
        end
    end
    return nil
end

-- ESP management
local ESPs = {} -- map fruit -> {gui, updater}
local function createESP(fruit)
    if not getgenv().ESPEnabled then return end
    if not fruit or not fruit:IsDescendantOf(workspace) then return end
    if ESPs[fruit] then return ESPs[fruit] end

    local handle = fruit:FindFirstChild("Handle") or fruit:FindFirstChildWhichIsA("BasePart")
    if not handle then return end

    local bill = Instance.new("BillboardGui")
    bill.Name = "FruitESP"
    bill.Adornee = handle
    bill.Size = UDim2.new(0,200,0,50)
    bill.AlwaysOnTop = true
    bill.StudsOffset = Vector3.new(0, 2 + (handle.Size.Y/2), 0)
    bill.Parent = handle

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1,0,1,0)
    txt.BackgroundTransparency = 1
    txt.TextColor3 = Color3.fromRGB(255,255,230)
    txt.TextStrokeTransparency = 0.6
    txt.TextScaled = true
    txt.Font = Enum.Font.GothamBold
    txt.Text = tostring(fruit.Name)
    txt.Parent = bill

    -- updater
    local conn
    conn = RunService.RenderStepped:Connect(function()
        if not fruit or not fruit.Parent or not handle.Parent then
            if conn then conn:Disconnect() end
            if bill then bill:Destroy() end
            ESPs[fruit] = nil
            return
        end
        local dist = (player.Character and player.Character:FindFirstChild("HumanoidRootPart") and (player.Character.HumanoidRootPart.Position - handle.Position).Magnitude) or 0
        txt.Text = string.format("%s | %.1f m", tostring(fruit.Name), dist)
    end)

    ESPs[fruit] = {gui = bill, conn = conn}
    return ESPs[fruit]
end

-- Cleanup ESP when fruit removed
workspace.DescendantRemoving:Connect(function(obj)
    if ESPs[obj] then
        if ESPs[obj].conn then ESPs[obj].conn:Disconnect() end
        if ESPs[obj].gui then ESPs[obj].gui:Destroy() end
        ESPs[obj] = nil
    end
end)

-- Fly-to logic using BodyVelocity
local function flyToPosition(targetPos, maxTime)
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return false end
    local hrp = char.HumanoidRootPart
    local bv = Instance.new("BodyVelocity")
    bv.Name = "NightX_FlyBV"
    bv.MaxForce = Vector3.new(1e5,1e5,1e5)
    bv.Velocity = Vector3.new(0,0,0)
    bv.Parent = hrp

    local start = tick()
    while hrp and hrp.Parent and (tick() - start) < (maxTime or 10) do
        if (hrp.Position - targetPos).Magnitude <= getgenv().PickupDistance then
            break
        end
        local dir = (targetPos - hrp.Position)
        if dir.Magnitude > 0.1 then
            bv.Velocity = dir.Unit * getgenv().FlySpeed
        else
            bv.Velocity = Vector3.new(0,0,0)
        end
        task.wait(0.03)
    end

    if bv and bv.Parent then
        bv:Destroy()
    end
    return true
end

-- Function to attempt pickup/store
local function attemptStoreTool(tool)
    if not tool then return end
    -- Try to invoke server "StoreFruit" if available
    local remotes = game:GetService("ReplicatedStorage"):FindFirstChild("Remotes")
    if remotes and remotes:FindFirstChild("CommF_") then
        pcall(function()
            local originalName = tool:GetAttribute("OriginalName") or tool.Name
            remotes.CommF_:InvokeServer("StoreFruit", originalName, tool)
        end)
    end
    -- Send webhook notification (if module available)
    pcall(function()
        if WebhookModule and WebhookModule.Send then
            WebhookModule.Send({
                player = player.Name,
                fruitName = tool.Name or tostring(tool),
                placeId = tostring(game.PlaceId),
                time = os.date("!*t")
            })
        end
    end)
end

-- Main collector loop (single pass scanning existing fruits, then listen for new fruits)
local function collectNearbyFruits()
    if not getgenv().AutoCollect then return end
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local hrp = char.HumanoidRootPart

    -- scan current workspace children for fruits
    for _, obj in ipairs(workspace:GetDescendants()) do
        if not getgenv().AutoCollect then break end
        if (obj:IsA("Tool") or obj:IsA("Model")) and obj.Name:find("Fruit") then
            local handle = obj:FindFirstChild("Handle") or obj:FindFirstChildWhichIsA("BasePart")
            if handle and handle.Position then
                createESP(obj)
                local targetPos = handle.Position + Vector3.new(0, (handle.Size.Y/2) + 1.5, 0)
                -- fly to it
                flyToPosition(targetPos, 12)
                task.wait(0.15)
                -- try find tool in character/backpack and store
                local foundTool = findFruitTool()
                if foundTool then
                    attemptStoreTool(foundTool)
                    task.wait(0.6)
                else
                    -- if the object itself is a Tool, maybe pickup occurs on touch; wait a bit then check backpack/char again
                    task.wait(0.8)
                    foundTool = findFruitTool()
                    if foundTool then
                        attemptStoreTool(foundTool)
                        task.wait(0.6)
                    end
                end
                task.wait(0.4)
            end
        end
    end
end

-- Auto collect when new fruit appears (spawn)
workspace.DescendantAdded:Connect(function(desc)
    if not getgenv().AutoCollect then return end
    if (desc:IsA("Tool") or desc:IsA("Model")) and desc.Name:find("Fruit") then
        -- small delay to ensure handle exists
        task.wait(0.05)
        collectNearbyFruits()
    end
end)

-- initial run
task.spawn(function()
    while true do
        if getgenv().AutoCollect then
            pcall(collectNearbyFruits)
        end
        task.wait(1)
    end
end)

-- Optional: expose controls to getgenv for runtime changes
getgenv().ToggleAutoCollect = function()
    getgenv().AutoCollect = not getgenv().AutoCollect
    return getgenv().AutoCollect
end

getgenv().ToggleESP = function()
    getgenv().ESPEnabled = not getgenv().ESPEnabled
    if not getgenv().ESPEnabled then
        -- cleanup
        for k,v in pairs(ESPs) do
            if v.conn then v.conn:Disconnect() end
            if v.gui then v.gui:Destroy() end
            ESPs[k] = nil
        end
    end
    return getgenv().ESPEnabled
end

print("PHUCMAX depzai:", getgenv().FlySpeed)
